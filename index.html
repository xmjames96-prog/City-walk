<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>城市迷踪 v1.1.5</title>
    
    <!-- React & ReactDOM -->
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
      tailwind.config = {
        theme: {
          extend: {
            colors: {
              orange: { 50: '#fff7ed', 100: '#ffedd5', 500: '#f97316', 600: '#ea580c' }
            }
          }
        }
      }
    </script>

    <!-- Leaflet CSS & JS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        body { background-color: #F8FAFC; overflow: hidden; touch-action: none; }
        .pt-safe { padding-top: env(safe-area-inset-top, 20px); }
        .mb-safe { margin-bottom: env(safe-area-inset-bottom, 20px); }
        .pb-safe { padding-bottom: env(safe-area-inset-bottom, 20px); }
        
        /* Leaflet Customization */
        .custom-pin { background: transparent; border: none; }
        .custom-label { background: transparent; border: none; }
        .leaflet-control-attribution { display: none !important; }
        
        /* Animations */
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        .animate-in { animation: fadeIn 0.3s ease-out; }
        
        /* Button Press Effect */
        .btn-press:active { transform: scale(0.92); transition: transform 0.1s; }
    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef } = React;
        
        // --- Safe Storage ---
        const safeLocalStorage = {
            getItem: (key) => { try { return localStorage.getItem(key); } catch (e) { return null; } },
            setItem: (key, value) => { try { localStorage.setItem(key, value); } catch (e) { } }
        };

        // --- Icon Component ---
        const Icon = ({ name, size = 24, className = "", ...props }) => {
            const iRef = useRef(null);
            useEffect(() => {
                if (window.lucide && iRef.current) {
                    window.lucide.createIcons({
                        root: iRef.current,
                        nameAttr: 'data-lucide',
                        attrs: { width: size, height: size, class: className, ...props }
                    });
                }
            }, [name, size, className]); 
            return <span ref={iRef} className={`inline-flex items-center justify-center ${className}`}><i data-lucide={name}></i></span>;
        };

        // --- SVG Marker Helper ---
        const getMarkerSVGString = (type) => {
            const color = "#f97316"; 
            const paths = {
                park: `<path d="M12 20L22 10L32 20H12Z" fill="${color}"/><rect x="19" y="20" width="6" height="10" fill="${color}"/>`, 
                river: `<path d="M4 18Q12 12 20 18T36 18" stroke="${color}" stroke-width="3" fill="none"/>`, 
                forest: `<path d="M10 24L22 4L34 24H10Z" fill="${color}"/><path d="M4 24L14 10L24 24H4Z" fill="${color}" opacity="0.7"/>`, 
                "avoid-mall": `<circle cx="20" cy="20" r="10" stroke="${color}" stroke-width="2" fill="none"/><line x1="14" y1="14" x2="26" y2="26" stroke="${color}" stroke-width="2"/>`, 
                culture: `<rect x="10" y="14" width="20" height="16" stroke="${color}" stroke-width="2" fill="none"/><path d="M10 14L20 6L30 14" stroke="${color}" stroke-width="2" fill="none"/>`, 
                crowd: `<circle cx="14" cy="14" r="4" fill="${color}"/><circle cx="26" cy="14" r="4" fill="${color}"/><path d="M10 26C10 22 14 22 14 22" stroke="${color}" stroke-width="2"/>` 
            };
            const path = paths[type] || `<circle cx="20" cy="20" r="8" fill="${color}"/>`;
            return `<svg width="40" height="40" viewBox="0 0 40 40" xmlns="http://www.w3.org/2000/svg">${path}</svg>`;
        };

        // --- Data Helpers ---
        const getPOIName = (type) => {
            const names = {
                park: ["街心公园", "社区绿地", "市政公园", "口袋公园"],
                river: ["沿河栈道", "亲水平台", "人工湖畔", "溪流小径"],
                forest: ["林荫大道", "城市绿道", "生态长廊"],
                culture: ["历史街区", "文化广场", "艺术中心"],
                crowd: ["商业步行街", "购物中心广场", "繁华路口"],
                "avoid-mall": ["静谧小径", "幽静后街", "林间小路"],
            };
            const list = names[type] || ["城市绿道", "休闲步道"];
            return list[Math.floor(Math.random() * list.length)];
        };

        const getWaypointLabel = (id) => {
             const map = {
                park: "公园", river: "河流", forest: "森林",
                "avoid-mall": "避开商圈", culture: "文化地标", crowd: "热闹人潮"
            };
            return map[id] || id;
        };

        // --- SVG Icons for Home Page ---
        const SVGIcons = {
            Walking: () => (
                <svg viewBox="0 0 64 64" className="w-8 h-8 text-orange-500"><circle cx="32" cy="12" r="6" fill="currentColor" /><path d="M32 20 L32 40 M22 28 L42 28 M32 40 L28 56 M32 40 L36 56" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" fill="none" /></svg>
            ),
            Nature: () => (
                <svg viewBox="0 0 64 64" className="w-8 h-8 text-orange-500"><path d="M32 8 L36 22 L50 22 L40 30 L44 44 L32 36 L20 44 L24 30 L14 22 L28 22 Z" fill="currentColor" /><path d="M16 48 Q16 54 20 58 M32 50 L32 58 M48 48 Q48 54 44 58" stroke="currentColor" strokeWidth="2" strokeLinecap="round" /></svg>
            ),
            Runner: () => (
                <svg viewBox="0 0 64 64" className="w-8 h-8 text-orange-500"><circle cx="36" cy="10" r="5" fill="currentColor" /><path d="M36 16 L36 34 M26 22 L46 26 M36 34 L28 48 M36 34 L42 52" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" strokeLinejoin="round" fill="none" /><path d="M42 52 L50 56 M28 48 L20 54" stroke="currentColor" strokeWidth="2.5" strokeLinecap="round" /></svg>
            ),
            Dice: () => (
                <svg viewBox="0 0 64 64" className="w-8 h-8 text-orange-500"><rect x="16" y="20" width="32" height="32" rx="4" stroke="currentColor" strokeWidth="2.5" fill="none" /><circle cx="24" cy="28" r="2" fill="currentColor" /><circle cx="40" cy="28" r="2" fill="currentColor" /><circle cx="32" cy="36" r="2" fill="currentColor" /><circle cx="24" cy="44" r="2" fill="currentColor" /><circle cx="40" cy="44" r="2" fill="currentColor" /></svg>
            )
        };
        
        // --- Basic Components ---
        const Header = () => (
            <header className="bg-gradient-to-b from-orange-50 to-transparent pt-safe">
                <div className="max-w-2xl mx-auto px-6 py-4 flex items-center justify-between">
                    <div className="flex items-center gap-3">
                        <Icon name="map-pin" className="text-orange-500" size={24} />
                        <span className="text-2xl font-bold text-gray-800">城市迷踪</span>
                        <span className="bg-gray-200 text-gray-600 text-[10px] px-1.5 py-0.5 rounded font-mono">v1.1.5</span>
                    </div>
                </div>
            </header>
        );

        // --- Distance & Time Options ---
        const DistanceOptions = ({ selected, onSelect }) => {
            const OptionBtn = ({ val, icon: SvgIcon, label }) => (
                <button
                    onClick={() => onSelect(val)}
                    className={`p-6 rounded-3xl font-bold text-center transition-all ${
                        selected === val
                        ? "bg-orange-100 border-2 border-orange-400 shadow-sm"
                        : "bg-white border-2 border-gray-100 hover:border-orange-200"
                    }`}
                >
                    <div className="flex flex-col items-center justify-center gap-2">
                         <div className="w-16 h-16 rounded-full bg-orange-100 flex items-center justify-center">
                            <SvgIcon />
                         </div>
                         <div className="flex items-baseline justify-center gap-0.5">
                            <span className="text-2xl font-bold text-gray-800">{label || val}</span>
                            {typeof val === 'number' && <span className="text-xs font-medium text-gray-500">公里</span>}
                         </div>
                         {val === "random" && <span className="text-xs font-medium text-gray-500">随机模式</span>}
                    </div>
                </button>
            );

            return (
                <div className="mb-6 grid grid-cols-2 gap-4">
                    <OptionBtn val={1} label="1" icon={SVGIcons.Walking} />
                    <OptionBtn val={3} label="3" icon={SVGIcons.Nature} />
                    <OptionBtn val={5} label="5" icon={SVGIcons.Runner} />
                    <OptionBtn val="random" label="随机" icon={SVGIcons.Dice} />
                </div>
            );
        };

        const TimeOptions = ({ selected, onSelect }) => (
            <div className="mb-6 grid grid-cols-2 gap-4">
                {[15, 30, 60].map((time) => (
                    <button
                        key={time}
                        onClick={() => onSelect(time)}
                        className={`p-6 rounded-3xl font-bold text-center transition-all ${
                            selected === time
                            ? "bg-orange-200 border-2 border-orange-500 shadow-md"
                            : "bg-white border-2 border-gray-200 hover:border-orange-200"
                        }`}
                    >
                        <div className="text-4xl mb-2">{time}</div>
                        <div className="text-xs text-gray-500 mt-1">分钟</div>
                    </button>
                ))}
            </div>
        );

        // --- Waypoint Filters ---
        const WaypointFilters = ({ selected, onSelect }) => {
            const waypoints = [
                {id: "park", icon: "trees", label: "公园"},
                {id: "river", icon: "waves", label: "河流"},
                {id: "forest", icon: "tent-tree", label: "森林"},
                {id: "avoid-mall", icon: "store", label: "避开商圈"},
                {id: "culture", icon: "landmark", label: "文化地标"},
                {id: "crowd", icon: "users", label: "热闹人潮"}
            ];
            
            const toggle = (id) => {
                const newSelected = selected.includes(id) 
                    ? selected.filter(w => w !== id) 
                    : [...selected, id];
                if (typeof onSelect === 'function') onSelect(newSelected);
            };

            return (
                <div className="mb-8">
                    <h2 className="text-lg font-bold text-gray-800 mb-4">选择途径</h2>
                    <div className="grid grid-cols-3 gap-3">
                        {waypoints.map((wp) => {
                            const isSelected = selected.includes(wp.id);
                            return (
                                <button
                                    key={wp.id}
                                    onClick={() => toggle(wp.id)}
                                    className={`px-3 py-3 rounded-2xl font-medium text-xs transition-all flex flex-col items-center gap-1.5 ${
                                        isSelected 
                                        ? "bg-orange-500 text-white shadow-md border-orange-500" 
                                        : "bg-white text-orange-500 border border-orange-200 hover:border-orange-400"
                                    }`}
                                >
                                    <Icon name={wp.icon} size={20} className={isSelected ? "text-white" : "text-orange-500"} />
                                    <div className="text-xs">{wp.label}</div>
                                </button>
                            );
                        })}
                    </div>
                </div>
            );
        };

        // --- Leaflet Map Component (Real Geo Focus) ---
        const LeafletMap = ({ selectedWaypoints = [], targetDistance, pageTitle = "", onBack }) => {
            const mapContainerRef = useRef(null);
            const mapInstanceRef = useRef(null);
            const routeLayerRef = useRef(null);
            const markerLayerRef = useRef(null);
            const tileLayerRef = useRef(null);

            const [permissionGranted, setPermissionGranted] = useState(false);
            const [initialLocation, setInitialLocation] = useState(null);
            const [routeInfo, setRouteInfo] = useState(null); 
            const [status, setStatus] = useState("准备中...");
            const [appState, setAppState] = useState("initializing");
            const [isPaused, setIsPaused] = useState(false);
            const [isMockLocation, setIsMockLocation] = useState(false);
            const [geoError, setGeoError] = useState(null);
            
            const [showLayerMenu, setShowLayerMenu] = useState(false);
            const [mapStyle, setMapStyle] = useState('light');

            useEffect(() => {
                checkPermissionAndInit();
                return () => {
                    if (mapInstanceRef.current) {
                        mapInstanceRef.current.remove();
                        mapInstanceRef.current = null;
                    }
                };
            }, []);

            const checkPermissionAndInit = () => {
                const hasAuth = safeLocalStorage.getItem("geo_permission_granted");
                if (hasAuth) {
                    setPermissionGranted(true);
                    requestPermission(true); 
                } else {
                    requestPermission(false);
                }
            };

            const requestPermission = (silent = false) => {
                if (!navigator.geolocation) {
                    setGeoError("您的设备不支持定位");
                    if(!silent) alert("您的浏览器不支持地理位置");
                    return;
                }
                
                if(!silent) setStatus("正在获取真实定位...");
                
                navigator.geolocation.getCurrentPosition(
                    (pos) => {
                        console.log("Real Location Found:", pos.coords.latitude, pos.coords.longitude);
                        safeLocalStorage.setItem("geo_permission_granted", "true");
                        setPermissionGranted(true);
                        setIsMockLocation(false);
                        setGeoError(null);
                        initMap(false, { lat: pos.coords.latitude, lng: pos.coords.longitude });
                    },
                    (err) => {
                        console.warn("Geo error:", err.code, err.message);
                        let msg = "定位失败";
                        if (err.code === 1) msg = "请在设置中允许定位权限";
                        if (err.code === 2) msg = "GPS信号弱或网络问题";
                        if (err.code === 3) msg = "定位超时";
                        setGeoError(msg);
                        setPermissionGranted(false); 
                    },
                    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
                );
            };

            const handleUseMockLocation = () => {
                setIsMockLocation(true);
                setPermissionGranted(true);
                initMap(true);
            };

            const handleRetryLocation = () => {
                setGeoError(null);
                requestPermission(false);
            };

            const initMap = (useFallback, customLoc) => {
                if (!mapContainerRef.current || mapInstanceRef.current) return;
                
                const L = window.L;
                if (!L) { setTimeout(() => initMap(useFallback, customLoc), 200); return; }

                const map = L.map(mapContainerRef.current, { zoomControl: false, attributionControl: false });
                
                const tileLayer = L.tileLayer('https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png', {
                    maxZoom: 18, 
                    subdomains: 'abcd',
                    attribution: '&copy; CARTO'
                }).addTo(map);
                tileLayerRef.current = tileLayer;
                
                routeLayerRef.current = L.layerGroup().addTo(map);
                markerLayerRef.current = L.layerGroup().addTo(map);
                mapInstanceRef.current = map;

                setTimeout(() => map.invalidateSize(), 200);

                if (customLoc) {
                    setInitialLocation(customLoc);
                    setStatus(`已定位。正在规划 ${targetDistance/1000}km 路线...`);
                    
                    const userIcon = L.divIcon({
                        className: 'custom-pin',
                        html: `<div style="position:relative; width:20px; height:20px;">
                                 <div style="position:absolute; inset:0; background:#3b82f6; border-radius:50%; opacity:0.3; animation: ping 1s infinite;"></div>
                                 <div style="position:absolute; inset:2px; background:#3b82f6; border:2px solid white; border-radius:50%;"></div>
                               </div>`,
                        iconSize: [20, 20]
                    });
                    L.marker([customLoc.lat, customLoc.lng], {icon: userIcon}).addTo(map);

                    generateSingleRoute(map, customLoc, targetDistance/1000);
                } else {
                    setStatus("使用演示位置(深圳湾)...");
                    generateSingleRoute(map, { lat: 22.5333, lng: 113.9304 }, targetDistance/1000);
                }
            };
            
            const changeMapStyle = (style) => {
                if (!tileLayerRef.current) return;
                let url = '';
                if (style === 'light') url = 'https://{s}.basemaps.cartocdn.com/rastertiles/voyager/{z}/{x}/{y}{r}.png';
                else if (style === 'dark') url = 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png';
                else if (style === 'satellite') url = 'https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}';
                
                tileLayerRef.current.setUrl(url);
                setMapStyle(style);
                setShowLayerMenu(false);
            };

            const generateSingleRoute = async (map, startLoc, targetKm, attempt = 1) => {
                const L = window.L;
                setStatus(`正在智能规划...`);

                map.setView([startLoc.lat, startLoc.lng], 15);
                
                const estimatedLinearKm = targetKm * 0.6;
                const deg = estimatedLinearKm / 111;
                const angle = Math.random() * 2 * Math.PI; 
                const endLat = startLoc.lat + deg * Math.cos(angle);
                const endLng = startLoc.lng + deg * Math.sin(angle);
                
                const midLat = (startLoc.lat + endLat) / 2;
                const midLng = (startLoc.lng + endLng) / 2;
                const dx = endLng - startLoc.lng;
                const dy = endLat - startLoc.lat;
                const len = Math.sqrt(dx*dx + dy*dy);
                const pdx = -dy/len; const pdy = dx/len;
                const offsetDeg = (targetKm * 0.25) / 111;
                const side = Math.random() > 0.5 ? 1 : -1;
                const wpLat = midLat + pdx * offsetDeg * side;
                const wpLng = midLng + pdy * offsetDeg * side;

                const waypoints = [startLoc, { lat: wpLat, lng: wpLng }, { lat: endLat, lng: endLng }];
                const coordsString = waypoints.map(p => `${p.lng},${p.lat}`).join(';');
                const url = `https://router.project-osrm.org/route/v1/walking/${coordsString}?overview=full&geometries=geojson`;

                try {
                    const res = await fetch(url);
                    const data = await res.json();
                    if (!data.routes || !data.routes.length) return null;
                    
                    const route = data.routes[0];
                    const geojson = route.geometry.coordinates.map(c => [c[1], c[0]]);
                    const distKm = (route.distance / 1000).toFixed(1);
                    const timeMin = Math.round((route.distance / 1000 / 5) * 60);
                    
                    if (Math.abs(distKm - targetKm) > targetKm * 0.3 && attempt < 3) {
                         setTimeout(() => generateSingleRoute(map, startLoc, targetKm, attempt + 1), 500);
                         return;
                    }

                    renderRouteOnMap({
                        coordinates: geojson,
                        distance: distKm,
                        time: timeMin,
                        waypoints: selectedWaypoints.length ? selectedWaypoints.map(getWaypointLabel).join('、') : "自由探索"
                    });
                    
                    setAppState("preview");
                } catch (e) {
                    console.error("Routing Error:", e);
                    setStatus("规划失败");
                }
            };

            const renderRouteOnMap = (routeData) => {
                if (!routeLayerRef.current || !markerLayerRef.current) return;
                const L = window.L;
                
                routeLayerRef.current.clearLayers();
                markerLayerRef.current.clearLayers();

                const coordinates = routeData.coordinates;

                // Gradient Route
                for (let i = 0; i < coordinates.length - 1; i++) {
                    const p1 = coordinates[i];
                    const p2 = coordinates[i+1];
                    const ratio = i / coordinates.length;
                    const r = Math.round(66 + (249 - 66) * ratio);
                    const g = Math.round(133 + (115 - 133) * ratio);
                    const b = Math.round(244 + (22 - 244) * ratio);
                    const color = `rgb(${r},${g},${b})`;
                    L.polyline([p1, p2], { color: color, weight: 6, opacity: 0.9, lineCap: 'round' }).addTo(routeLayerRef.current);
                }
                
                mapInstanceRef.current.fitBounds(L.polyline(coordinates).getBounds(), { padding: [50, 50] });

                // Start Marker
                const startIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="display:flex; flex-direction:column; align-items:center; transform:translate(0, -100%); white-space:nowrap;">
                            <div style="background:#3b82f6; color:white; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; margin-bottom:4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">起点</div>
                            <div style="width:16px; height:16px; background:#3b82f6; border:2px solid white; border-radius:50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                           </div>`,
                    iconSize: [0, 0]
                });
                L.marker(coordinates[0], {icon: startIcon}).addTo(markerLayerRef.current);

                // End Marker
                const endIcon = L.divIcon({
                    className: 'custom-pin',
                    html: `<div style="display:flex; flex-direction:column; align-items:center; transform:translate(0, -100%); white-space:nowrap;">
                            <div style="background:#ef4444; color:white; font-size:10px; padding:2px 6px; border-radius:4px; font-weight:bold; margin-bottom:4px; box-shadow: 0 2px 4px rgba(0,0,0,0.2);">终点</div>
                            <div style="width:16px; height:16px; background:#ef4444; border:2px solid white; border-radius:50%; box-shadow: 0 2px 4px rgba(0,0,0,0.2);"></div>
                           </div>`,
                    iconSize: [0, 0]
                });
                L.marker(coordinates[coordinates.length-1], {icon: endIcon}).addTo(markerLayerRef.current);

                if (selectedWaypoints.length > 0) {
                    selectedWaypoints.forEach((wp, i) => {
                        const idx = Math.floor(coordinates.length * ((i+1) / (selectedWaypoints.length+1)));
                        const pos = coordinates[idx];
                        const name = getPOIName(wp);
                        const svgStr = getMarkerSVGString(wp);
                        
                        const wpHtml = `
                            <div style="transform:translate(-50%, -100%); display:flex; flex-direction:column; align-items:center;">
                                <div style="background:white; padding:4px 8px; border-radius:12px; box-shadow:0 4px 6px rgba(0,0,0,0.15); display: flex; gap: 4px; align-items: center; border: 1px solid #f97316; margin-bottom: 2px;">
                                    <div style="width:16px; height:16px; display:flex; align-items:center; justify-content:center;">${svgStr}</div>
                                    <div style="display:flex; flex-direction:column; align-items:flex-start; line-height:1;">
                                        <span style="font-size:9px; color:#f97316; font-weight:800;">${(routeData.distance * (i+1)/(selectedWaypoints.length+1)).toFixed(1)}km</span>
                                        <span style="font-size:10px; color:#333; font-weight:bold; white-space:nowrap;">${name}</span>
                                    </div>
                                </div>
                                <div style="width: 0; height: 0; border-left: 5px solid transparent; border-right: 5px solid transparent; border-top: 6px solid #f97316;"></div>
                                <div style="width:8px; height:8px; background:#f97316; border:2px solid white; border-radius:50%; margin-top:-2px; box-shadow: 0 1px 3px rgba(0,0,0,0.3);"></div>
                            </div>
                        `;
                        L.marker(pos, {
                            icon: L.divIcon({ className: 'custom-label', html: wpHtml, iconSize: [0, 0] })
                        }).addTo(markerLayerRef.current);
                    });
                }
                
                setRouteInfo(routeData);
            };

            const handleStartNav = () => setAppState("navigating");
            const handleStopNav = () => { setAppState("stopped"); setIsPaused(false); };
            const handleRefresh = () => {
                if(initialLocation && mapInstanceRef.current) generateSingleRoute(mapInstanceRef.current, initialLocation, targetDistance/1000);
            };
            
            return (
                <div className="relative h-screen w-full bg-[#F8FAFC] overflow-hidden flex flex-col">
                    
                    {/* 定位提示条 */}
                    {isMockLocation && (
                        <div className="absolute top-0 left-0 right-0 z-[2000] bg-yellow-100 text-yellow-800 text-xs px-4 py-2 text-center pt-safe border-b border-yellow-200">
                            未能获取真实位置 (演示模式)
                        </div>
                    )}

                    {/* Geo Error Modal */}
                    {geoError && !permissionGranted && (
                         <div className="absolute inset-0 z-[2000] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
                            <div className="bg-white rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl">
                                <div className="w-16 h-16 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-6 text-red-500"><Icon name="map-pin-off" size={32} /></div>
                                <h3 className="text-xl font-bold text-gray-900 mb-2">定位遇到问题</h3>
                                <p className="text-red-500 text-sm mb-2 font-medium">{geoError}</p>
                                <p className="text-gray-500 text-xs mb-8">
                                    如使用微信/浏览器，请检查是否已授权位置权限。
                                </p>
                                <div className="space-y-3">
                                    <button onClick={handleRetryLocation} className="w-full py-3 bg-gray-900 text-white font-bold rounded-xl shadow-lg btn-press">重试定位</button>
                                    <button onClick={handleUseMockLocation} className="w-full py-3 bg-gray-100 text-gray-600 font-bold rounded-xl btn-press">使用演示模式</button>
                                </div>
                            </div>
                        </div>
                    )}

                    {!permissionGranted && !geoError && (
                        <div className="absolute inset-0 z-[2000] bg-black/60 backdrop-blur-sm flex items-center justify-center p-6">
                            <div className="bg-white rounded-3xl p-8 w-full max-w-sm text-center shadow-2xl">
                                <div className="w-16 h-16 bg-orange-100 rounded-full flex items-center justify-center mx-auto mb-6 text-orange-500"><Icon name="map-pin" size={32} /></div>
                                <h3 className="text-xl font-bold text-gray-900 mb-3">开启城市探索</h3>
                                <p className="text-gray-500 text-sm mb-8">我们需要获取您的位置以规划路线 (v1.1.5)</p>
                                <button onClick={() => requestPermission(false)} className="w-full py-3 bg-gray-900 text-white font-bold rounded-xl shadow-lg btn-press">允许访问位置</button>
                            </div>
                        </div>
                    )}

                    <div className="absolute top-0 left-0 right-0 z-[1000] bg-white/90 backdrop-blur-md border-b border-slate-200 shadow-sm pt-safe" style={{top: isMockLocation ? '34px' : '0'}}>
                        <div className="flex items-center justify-between px-4 py-3">
                            <button onClick={onBack} className="p-2 -ml-2 text-slate-700 hover:bg-slate-100 rounded-full transition"><Icon name="chevron-left" size={24} /></button>
                            <div className="flex flex-col items-center">
                                <span className="font-bold text-slate-800 text-sm">{pageTitle}</span>
                                {appState === 'navigating' && (<div className="flex items-center gap-2 text-[10px]">{isPaused ? <span className="text-orange-500 font-medium">已暂停</span> : <span className="text-green-600 font-medium">导航中</span>}</div>)}
                            </div>
                            <div className="w-8"></div>
                        </div>
                    </div>

                    <div className="flex-1 relative w-full h-full z-0 bg-slate-100">
                        {appState === 'initializing' && permissionGranted && (
                            <div className="absolute inset-0 flex items-center justify-center bg-slate-50/50 backdrop-blur-sm z-10">
                                <div className="bg-white px-6 py-4 rounded-2xl shadow-xl flex flex-col items-center gap-3">
                                    <Icon name="loader-2" className="animate-spin text-orange-500" size={32} />
                                    <div className="text-center"><div className="font-bold text-slate-800">正在智能规划...</div><div className="text-xs text-slate-500 mt-1">{status}</div></div>
                                </div>
                            </div>
                        )}
                        
                        {/* 1. 地图图层切换入口 */}
                        {appState === 'preview' && (
                            <div className="absolute top-20 right-4 z-[900] flex flex-col gap-3">
                                <div className="relative">
                                    <button onClick={() => setShowLayerMenu(!showLayerMenu)} className="bg-white p-3 rounded-full shadow-lg text-slate-600 hover:text-orange-500 transition-colors"><Icon name="layers" size={20} /></button>
                                    {showLayerMenu && (
                                        <div className="absolute right-12 top-0 bg-white rounded-xl shadow-xl p-2 w-32 flex flex-col gap-1 border border-slate-100 animate-in">
                                            <button onClick={() => changeMapStyle('light')} className={`px-3 py-2 text-xs font-medium text-left rounded-lg ${mapStyle==='light' ? 'bg-orange-50 text-orange-600' : 'text-slate-600 hover:bg-slate-50'}`}>标准清新</button>
                                            <button onClick={() => changeMapStyle('dark')} className={`px-3 py-2 text-xs font-medium text-left rounded-lg ${mapStyle==='dark' ? 'bg-orange-50 text-orange-600' : 'text-slate-600 hover:bg-slate-50'}`}>暗黑科技</button>
                                            <button onClick={() => changeMapStyle('satellite')} className={`px-3 py-2 text-xs font-medium text-left rounded-lg ${mapStyle==='satellite' ? 'bg-orange-50 text-orange-600' : 'text-slate-600 hover:bg-slate-50'}`}>卫星混合</button>
                                        </div>
                                    )}
                                </div>
                                {/* Refresh Button Removed as requested in v1.1.0 */}
                            </div>
                        )}

                        <div id="map-container" ref={mapContainerRef} className="w-full h-full" style={{background: '#f8fafc'}}></div>
                    </div>

                    {appState === 'preview' && routeInfo && (
                        <div className="absolute bottom-0 left-0 right-0 z-[1000] p-4 bg-transparent mb-safe">
                            <div className="bg-white rounded-3xl shadow-2xl p-5 border border-slate-100">
                                <div className="flex items-center justify-between mb-6">
                                    <div className="flex flex-col"><span className="text-xs text-slate-400 font-medium mb-1">全程距离</span><div className="flex items-baseline gap-1"><span className="text-2xl font-bold text-slate-900">{routeInfo.distance}</span><span className="text-sm text-slate-600 font-medium">公里</span></div></div>
                                    <div className="w-px h-8 bg-slate-100 mx-4"></div>
                                    <div className="flex flex-col"><span className="text-xs text-slate-400 font-medium mb-1">预计用时</span><div className="flex items-baseline gap-1"><span className="text-2xl font-bold text-slate-900">{routeInfo.time}</span><span className="text-sm text-slate-600 font-medium">分钟</span></div></div>
                                    <div className="w-px h-8 bg-slate-100 mx-4"></div>
                                    <div className="flex flex-col items-end"><span className="text-xs text-slate-400 font-medium mb-1">算法</span><div className="flex items-center gap-1 text-blue-600 bg-blue-50 px-2 py-1 rounded-lg"><Icon name="calculator" size={12} /><span className="text-xs font-bold">迭代逼近</span></div></div>
                                </div>
                                
                                <div className="bg-slate-50 rounded-xl p-3 mb-5 flex items-start gap-2">
                                    <Icon name="map" size={14} className="text-slate-400 mt-0.5 shrink-0" />
                                    <div className="text-xs text-slate-600 leading-relaxed line-clamp-2">
                                        <span className="font-bold text-slate-700">已选途径：</span>
                                        {routeInfo.waypoints}
                                    </div>
                                </div>

                                <button onClick={handleStartNav} className="w-full bg-slate-900 text-white font-bold py-4 rounded-2xl shadow-xl flex items-center justify-center gap-2 btn-press"><Icon name="navigation" size={18} />开始导航</button>
                            </div>
                        </div>
                    )}

                    {appState === 'navigating' && (
                        <div className="absolute bottom-12 left-0 right-0 z-[1000] flex justify-center gap-8 px-6 mb-safe pb-safe">
                            
                            {/* 2. 优化后的导航控制按钮 */}
                            <div className="flex flex-col items-center gap-2">
                                <button 
                                    onClick={() => setIsPaused(!isPaused)} 
                                    className={`w-16 h-16 rounded-full flex items-center justify-center shadow-xl transition-all btn-press ${isPaused ? 'bg-green-500 text-white' : 'bg-white text-slate-700'}`}
                                >
                                    <Icon name={isPaused ? "play" : "pause"} size={32} fill={isPaused ? "currentColor" : "currentColor"} />
                                </button>
                                <span className="text-xs font-bold text-slate-600 bg-white/80 px-2 py-0.5 rounded-full shadow-sm backdrop-blur">
                                    {isPaused ? "继续" : "暂停"}
                                </span>
                            </div>

                            <div className="flex flex-col items-center gap-2">
                                <button 
                                    onClick={handleStopNav} 
                                    className="w-16 h-16 rounded-full bg-red-500 flex items-center justify-center shadow-xl text-white transition-all btn-press"
                                >
                                    <Icon name="square" size={24} fill="currentColor" />
                                </button>
                                <span className="text-xs font-bold text-slate-600 bg-white/80 px-2 py-0.5 rounded-full shadow-sm backdrop-blur">
                                    结束
                                </span>
                            </div>

                        </div>
                    )}
                </div>
            );
        };

        const App = () => {
            const [view, setView] = useState('home');
            const [mode, setMode] = useState("distance");
            const [selectedDistance, setSelectedDistance] = useState(3);
            const [selectedTime, setSelectedTime] = useState(30);
            const [selectedWaypoints, setSelectedWaypoints] = useState([]);
            
            const [targetDistance, setTargetDistance] = useState(3000);
            const [headerTitle, setHeaderTitle] = useState("");

            const handleStart = () => {
                let distMeters = 3000;
                if (mode === 'distance') {
                    const d = selectedDistance === 'random' ? (Math.random() * 5 + 2) : selectedDistance;
                    distMeters = d * 1000;
                } else {
                    distMeters = selectedTime * 83.33;
                }
                
                const finalDistKm = (distMeters / 1000).toFixed(1);
                setHeaderTitle(`探索 - ${finalDistKm}公里`);
                setTargetDistance(distMeters);
                setView('detail');
            };

            return (
                <div className="font-sans h-screen flex flex-col">
                    {view === 'home' && (
                        <div className="flex-1 flex flex-col overflow-y-auto bg-gradient-to-b from-orange-50 to-orange-100/50">
                            <Header />
                            <div className="flex-1 px-6 pb-6 w-full max-w-md mx-auto mt-4">
                                {mode === "distance" ? <DistanceOptions selected={selectedDistance} onSelect={setSelectedDistance} /> : <TimeOptions selected={selectedTime} onSelect={setSelectedTime} />}
                                {/* Fixed: Correctly passing setter function */}
                                <WaypointFilters selected={selectedWaypoints} onSelect={setSelectedWaypoints} />
                                <button onClick={handleStart} className="w-full bg-orange-500 text-white font-bold py-4 rounded-2xl shadow-lg mt-auto btn-press">开始 GO</button>
                            </div>
                        </div>
                    )}
                    {view === 'detail' && (
                        <LeafletMap targetDistance={targetDistance} selectedWaypoints={selectedWaypoints} pageTitle={headerTitle} onBack={() => setView('home')} />
                    )}
                </div>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>